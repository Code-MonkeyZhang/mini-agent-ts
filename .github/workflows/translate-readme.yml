name: Translate README to English

on:
  push:
    paths:
      - 'README_CN.md' # 监听中文版源文件
    branches:
      - main
      - master
  workflow_dispatch: # 允许通过 GitHub UI 手动触发

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install openai

      - name: Translate README
        env:
          API_KEY: ${{ secrets.LLM_API_KEY }}
          API_BASE: 'https://api.deepseek.com/v1'
          MODEL: 'deepseek-chat'
        run: |
          python -c "
          import os
          import sys
          from openai import OpenAI

          api_key = os.environ.get('API_KEY')
          if not api_key:
              print('Error: API_KEY secret is not set.')
              sys.exit(1)

          client = OpenAI(api_key=api_key, base_url=os.environ['API_BASE'])

          try:
              # 读取源文件 (中文)
              with open('README_CN.md', 'r', encoding='utf-8') as f:
                  content = f.read()

              system_prompt = \"\"\"
              You are a professional technical translator. 
              Translate the following Chinese Markdown content into English.
              
              Rules:
              1. The input file starts with a navigation line like '[English](...) | [中文](...)'. Keep this line EXACTLY as is at the top.
              2. Keep all Markdown formatting, links, images, and code blocks unchanged.
              3. Translate the content to be natural, professional, and concise for English speakers.
              4. Do NOT translate command line instructions or technical terms that should remain in English (e.g., 'npm install', 'winget', 'Mini-Agent').
              5. Do not add any introductory or concluding remarks, just output the full translated content.
              \"\"\"

              response = client.chat.completions.create(
                  model=os.environ['MODEL'],
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': content}
                  ],
                  temperature=0.3
              )

              translated_content = response.choices[0].message.content

              # 写入目标文件 (英文，覆盖 README.md)
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(translated_content)
              
              print('Translation successful.')

          except Exception as e:
              print(f'Translation failed: {e}')
              sys.exit(1)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 检查是否有变化
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "docs: auto-translate README to English [skip ci]"
            git push
            echo "Successfully pushed translated README."
          else
            echo "No changes in translation."
          fi
